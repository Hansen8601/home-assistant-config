# Home assistant configuration file

# Used to switch between development & production system
homeassistant: !include homeassistant.yaml

frontend:
  javascript_version: latest

# Recorder
recorder:
  purge_interval: 1
  purge_keep_days: 7
  exclude:
    entities:
      - input_boolean.set_mode_sleeping
      - input_boolean.set_mode_home
      - input_boolean.set_mode_away
      - input_number.denon_deck_volume 
      - input_number.denon_volume
      - input_select.living_room_remote
      - binary_sensor.main_floor_occupancy
      - sensor.average_load_1m
      - sensor.average_load_5m
      - sensor.dark_sky_wind_bearing
      - sensor.dark_sky_wind_speed
      - sensor.dark_sky_temperature
#      - sensor.snmp_wan_in
#      - sensor.snmp_wan_out
      - automation.denon_set_volume
      - automation.denon__set_slider_to_volume
      - automation.activity_with_remote__set_automation_to_sleeping
      - automation.activity_with_remote__set_mode_to_home
      - automation.set_harmony_input_select_to_remote_activity
      - automation.monitor_in_traffic
      - automation.monitor_out_traffic
      - script.denon_deck_volume_down
      - script.denon_deck_volume_up
      - script.denon_deck_volume_set
      - input_number.internet_traffic_delta_in
      - input_number.internet_traffic_delta_out
    domains:
      - sun
      - script
      - media_player
      - remote
      - group


# View all events in a logbook
logbook:
  exclude:
    entities:
      - automation.denon_slider_volume_set
      - automation.denon_volume_set
      - automation.denon_deck_volume_set
      
      - binary_sensor.high_lux
      - binary_sensor.low_lux
      - input_boolean.set_mode_home
      - input_boolean.set_mode_sleeping
      - input_boolean.set_mode_away


# Enables support for tracking state changes over time.
history:
  exclude:
    domains:
      - automation
      - weblink
      - updater


# Logger settings
logger:
  default: warn


# Track the sun
sun:
  elevation: 278


# Allows you to issue voice commands from the frontend
#conversation:


# Checks for available updates
updater:


# Discover some devices automatically
discovery:


# Show configuration panel
config:


device_tracker:
  platform: mqtt
  devices:
    Phil: smartthings/Phil's iPhone/presence
    Nikki: smartthings/Nikki's iPhone/presence
    Dylan: smartthings/Dylan's iPhone/presence


#mqtt broker
mqtt:
  broker: !secret mqtt_broker
  port: 1883
  keepalive: 60


twilio:
  account_sid: !secret twillo_sid 
  auth_token: !secret twillo_token


notify:
  - name: twilio_sms
    platform: twilio_sms
    from_number: !secret twillo_number


media_player:
  - platform: denonavr
    host: !secret dennon_ip
    name: Denon AVRX3000
  - platform: plex


ecobee:
  api_key: !secret ecobee_api_key


apple_tv:
  - host: 192.168.1.127
    login_id: !secret apple_tv_login_id
    name: "Apple TV Workout room"
    start_off: true
  - host: 192.168.1.86
    login_id: !secret apple_tv_login_id
    name: "Apple TV"
    start_off: true
  - host: 192.168.1.95
    login_id: !secret apple_tv_login_id
    name: "Apple TV Basement"
    start_off: true


#panel_iframe:
#  router:
#    title: 'Cacti'
#    icon: 'mdi:network'
#    url: 'http://192.168.1.22:32770/cacti/graph_view.php?action=tree&node=tbranch-1&hgd=&hyper=true'


remote:
  - platform: harmony
    name: living_room
    host: !secret harmony_ip


rest_command:
  denon_deck_volume_set:
    url: !secret denon_url
    method: post
    payload: 'cmd0=PutMasterVolumeSet%2F{{((states.input_number.denon_deck_volume.state  | float)) - 80 }}&ZoneName=ZONE2'
  denon_deck_volume_up:
    url: !secret denon_url
    method: post
    payload: 'cmd0=PutMasterVolumeBtn%2F%3C&ZoneName=ZONE2'
  denon_deck_volume_down:
    url: !secret denon_url
    method: post
    payload: 'cmd0=PutMasterVolumeBtn%2F%3E&ZoneName=ZONE2'
  denon_deck_volume_50:
    url: !secret denon_url
    method: post
    payload: 'cmd0=PutMasterVolumeSet%2F-30&ZoneName=ZONE2'
  denon_deck_volume_55:
    url: !secret denon_url
    method: post
    payload: 'cmd0=PutMasterVolumeSet%2F-25&ZoneName=ZONE2'
  denon_deck_volume_60:
    url: !secret denon_url
    method: post
    payload: 'cmd0=PutMasterVolumeSet%2F-20&ZoneName=ZONE2'


###################
#                 #
# Binary Sensor   #
#                 #
###################

binary_sensor:
#  - platform: rpi_gpio
#    ports:
#      20: Garage Service Door RPI

  - platform: template
    sensors:
      low_lux:
        value_template: '{{states.sensor.living_room_lux.state | float  < states.input_number.lux_low_setpoint.state | float or
                           states.sensor.dark_sky_cloud_coverage.state | float > states.input_number.cloud_cover_setpoint.state | float }}' 
        friendly_name: 'Low Lux'

  - platform: template
    sensors:
      high_lux:
        value_template: '{{states.sensor.living_room_lux.state | float > states.input_number.lux_high_setpoint.state | float and
                           states.sensor.dark_sky_cloud_coverage.state | float < states.input_number.cloud_cover_setpoint.state | float }}'
        friendly_name: 'High Lux'

  - platform: template
    sensors:
      fireplace_off_sensor:
        value_template: '{{ states.sensor.living_room_temperature.state|float >=  states.input_number.fireplace_high_setpoint.state | float or
                            states.sensor.main_floor_temperature.state|float  >=  states.input_number.fireplace_high_setpoint.state | float }} '
        friendly_name: "Fireplace Off Sensor"

#  - platform: threshold
#    name: "Low LUX"
#    threshold: 50
#    type: lower
#    entity_id: sensor.living_room_lux

#  - platform: threshold
#    name: "High LUX"
#    threshold: 100 
#    type: upper
#    entity_id: sensor.living_room_lux


###################
#                 #
# Cover           #
#                 #
###################

cover:
#- platform: rpi_gpio
#  covers:
#    - relay_pin: 23
#      state_pin: 12
#      name: 'garage left'

#- platform: rpi_gpio
#  covers:
#    - relay_pin: 24
#      state_pin: 13
#      name: 'garage right'

- platform: mqtt
  state_topic: "rpi/garage/input/garagedoormain"
  command_topic: "rpi/garage/output/garagedoormain/set_on_ms"
  availability_topic: "rpi/garage/status"
  payload_available: "running"
  payload_not_available: "stopped"
  name: "garage right"
  qos: 0 #Must be zero to work correctly
  retain: false 
  payload_open: "500"
  payload_close: "500"
  state_open: "open"
  state_closed: "closed"
  #optimistic: false

- platform: mqtt
  state_topic: "rpi/garage/input/garagedoorshop"
  command_topic: "rpi/garage/output/garagedoorshop/set_on_ms"
  availability_topic: "rpi/garage/status"
  payload_available: "running"
  payload_not_available: "stopped"
  name: "garage left"
  qos: 0 #must be zero to work correctly.
  retain: false
  payload_open: "500"
  payload_close: "500"
  state_open: "open"
  state_closed: "closed"
  #optimistic: false


###################
#                 #
# Light           #
#                 #
###################

light:
- platform: mqtt
  name: "ge_living_room_1"
  state_topic: "smartthings/GE Living Room 1/switch"
  command_topic: "smartthings/GE Living Room 1/switch"
  brightness_state_topic: "smartthings/GE Living Room 1/level"
  brightness_command_topic: "smartthings/GE Living Room 1/level"
  brightness_scale: 99
  brightness_value_template: '{{ value }}'
  qos: 1
  payload_on: "on"
  payload_off: "off"
  optimistic: false
  retain: true
- platform: mqtt
  name: "ge_living_room_2"
  state_topic: "smartthings/GE Living Room 2/switch"
  command_topic: "smartthings/GE Living Room 2/switch"
  brightness_state_topic: "smartthings/GE Living Room 2/level"
  brightness_command_topic: "smartthings/GE Living Room 2/level"
  brightness_scale: 99
  brightness_value_template: '{{ value }}'
  qos: 1
  payload_on: "on"
  payload_off: "off"
  optimistic: false
  retain: true
- platform: mqtt
  name: "ge_living_room_3"
  state_topic: "smartthings/GE Living Room 3/switch"
  command_topic: "smartthings/GE Living Room 3/switch"
  brightness_state_topic: "smartthings/GE Living Room 3/level"
  brightness_command_topic: "smartthings/GE Living Room 3/level"
  brightness_scale: 99
  brightness_value_template: '{{ value }}'
  qos: 1
  payload_on: "on"
  payload_off: "off"
  optimistic: false
  retain: true
- platform: mqtt
  name: "Guest Bathroom Lights"
  state_topic: "smartthings/Guest Bathroom Lights/switch"
  command_topic: "smartthings/Guest Bathroom Lights/switch"
  brightness_state_topic: "smartthings/Guest Bathroom Lights/level"
  brightness_command_topic: "smartthings/Guest Bathroom Lights/level"
  brightness_scale: 99
  brightness_value_template: '{{ value }}'
  qos: 1
  payload_on: "on"
  payload_off: "off"
  optimistic: false
  retain: true
- platform: mqtt
  name: "Entry_Walkway_Dimmer_Switch"
  state_topic: "smartthings/Entry Walkway Dimmer Switch/switch"
  command_topic: "smartthings/Entry Walkway Dimmer Switch/switch"
  brightness_state_topic: "smartthings/Entry Walkway Dimmer Switch/level"
  brightness_command_topic: "smartthings/Entry Walkway Dimmer Switch/level"
  brightness_scale: 99
  brightness_value_template: '{{ value }}'
  qos: 1
  payload_on: "on"
  payload_off: "off"
  optimistic: false
  retain: true
- platform: mqtt
  name: "Garage_Outside_Lights"
  state_topic: "smartthings/Garage Outside Lights/switch"
  command_topic: "smartthings/Garage Outside Lights/switch"
  brightness_state_topic: "smartthings/Garage Outside Lights/level"
  brightness_command_topic: "smartthings/Garage Outside Lights/level"
  brightness_scale: 99
  brightness_value_template: '{{ value }}'
  qos: 1
  payload_on: "on"
  payload_off: "off"
  optimistic: false
  retain: true
- platform: mqtt
  name: "Master_Bathroom_Dimmer"
  state_topic: "smartthings/Master bathroom dimmer/switch"
  command_topic: "smartthings/Master bathroom dimmer/switch"
  brightness_state_topic: "smartthings/Master bathroom dimmer/level"
  brightness_command_topic: "smartthings/master bathroom dimmer/level"
  brightness_scale: 99
  brightness_value_template: '{{ value }}'
  qos: 1
  payload_on: "on"
  payload_off: "off"
  optimistic: false
  retain: true
- platform: mqtt
  name: "Master_Bathroom_Shower"
  state_topic: "smartthings/Master bathroom shower/switch"
  command_topic: "smartthings/Master bathroom shower/switch"
  qos: 1
  payload_on: "on"
  payload_off: "off"
  optimistic: false
  retain: true
- platform: mqtt
  name: "Upstairs_Hall_Scone"
  state_topic: "smartthings/Upstairs Hall Scone/switch"
  command_topic: "smartthings/Upstairs Hall Scone/switch"
  brightness_state_topic: "smartthings/Upstairs Hall Scone/level"
  brightness_command_topic: "smartthings/Upstairs Hall Scone/level"
  brightness_scale: 99
  brightness_value_template: '{{ value }}'
  qos: 1
  payload_on: "on"
  payload_off: "off"
  optimistic: false
  retain: true
- platform: mqtt
  name: "Kitchen_Cabinet_Lights"
  state_topic: "smartthings/Kitchen Cabinet Lights/switch"
  command_topic: "smartthings/Kitchen Cabinet Lights/switch"
  payload_on: "on"
  payload_off: "off"
  optimistic: false
  retain: true
- platform: mqtt
  name: "Kitchen_island_Lights"
  state_topic: "smartthings/Kitchen Island Lights/switch"
  command_topic: "smartthings/Kitchen Island Lights/switch"
  brightness_state_topic: "smartthings/Kitchen Island Lights/level"
  brightness_command_topic: "smartthings/Kitchen Island Lights/level"
  brightness_scale: 99
  brightness_value_template: '{{ value }}'
  qos: 1
  payload_on: "on"
  payload_off: "off"
  optimistic: false
  retain: true
- platform: mqtt
  name: "Master_bathroom_chandelier"
  state_topic: "smartthings/Master bathroom chandelier/switch"
  command_topic: "smartthings/Master bathroom chandelier/switch"
  brightness_state_topic: "smartthings/Master bathroom chandelier/level"
  brightness_command_topic: "smartthings/Master bathroom chandelier/level"
  brightness_scale: 99
  brightness_value_template: '{{ value }}'
  qos: 1
  payload_on: "on"
  payload_off: "off"
  optimistic: false
  retain: true


###################
#                 #
# Sensor          #
#                 #
###################

sensor:
- platform: darksky
  api_key: !secret dark_sky_api
  scan_interval: 240
  monitored_conditions:
    - temperature
    - cloud_cover
    - wind_speed
    - wind_bearing

- platform: template
  sensors:
    living_room_remote_activity:
      value_template: '{{ states.remote.living_room.attributes.current_activity }}'
      friendly_name: 'Living Room Remote Activity'

#- platform: template
#  sensors:
#     garage_service_door:
#       value_template: >-
#        {% if states.binary_sensor.garage_service_door_rpi.state == 'on' %}
#          Closed
#        {% elif states.binary_sensor.garage_service_door_rpi.state == 'off' %}
#          Open
#        {% else %}
#          n/a
#        {% endif %}

- platform: mqtt
  state_topic: "rpi/garage/input/servicedoor"
  name: "garage service door"

#- platform: mqtt
#  state_topic: "esp8266/garageIO/temperature"
#  name: "living_room_av_temperature"
#  unit_of_measurement: "°F"
#  value_template: '{{ value_json | float }}'

#- platform: mqtt
#  state_topic: "esp8266/garageIO/humidity"
#  name: 'living_room_av_humidity'
#  unit_of_measurement: '%'
#  value_template: '{{ value_json | float }}'

#- platform: mqtt
#  state_topic: "esp8266/garageIO/humidity"
#  name: 'garage_service_door_test'
#  unit_of_measurement: '%'
#  value_template: '{{ value_json | float }}'

- platform: mqtt
  state_topic: "smartthings/Aeon Multisensor 6/illuminance"
  name: "living_room_lux"
  unit_of_measurement: "Lux"
  value_template: '{{ value_json | float }}'

- platform: mqtt
  state_topic: "smartthings/Aeon Multisensor 6/temperature"
  name: "living_room_temperature"
  unit_of_measurement: "°F"
  value_template: '{{ value_json | float }}'

- platform: mqtt
  state_topic: "smartthings/Aeon Multisensor 6/humidity"
  name: "living_room_humidity"
  unit_of_measurement: "%"
  value_template: '{{ value_json | float }}'

#- platform: mqtt
#  state_topic: "smartthings/Aeon Multisensor 6/battery"
#  name: "living_room_battery"
#  unit_of_measure: '%'

# Disabling, not returning accurate results.
# Seems to be an ASUS snmp issue.
#- platform: snmp
#  name: "snmp_wan_in"
#  host: 192.168.1.1
#  version: 2c
#  accept_errors: true
#  community: !secret snmp_community
#  baseoid: 1.3.6.1.2.1.2.2.1.10.2
#- platform: snmp
#  name: "snmp_wan_out"
#  host: 192.168.1.1
#  version: 2c
#  accept_errors: true
#  community: !secret snmp_community
#  baseoid: 1.3.6.1.2.1.2.2.1.16.2

- platform: template
  sensors: 
    internet_speed_in:
      friendly_name: 'Internet Speed In'
      value_template: '{{ ((states.input_number.internet_traffic_delta_in.state | float )) | round(2) }}'
      unit_of_measurement: 'Mbps'

- platform: template
  sensors:
    internet_speed_out:
      friendly_name: 'Internet Speed Out'
      value_template: '{{ ((states.input_number.internet_traffic_delta_out.state | float )) | round(2) }}'
      unit_of_measurement: 'Mbps'

- platform: statistics
  name: 'WAN Traffic IN'
  entity_id: sensor.internet_speed_in

- platform: statistics
  name: 'WAN Traffic OUT'
  entity_id: sensor.internet_speed_out

- platform: systemmonitor
  resources:
    - type: memory_use_percent
    - type: swap_use_percent
    - type: load_1m
    - type: load_5m


###################
#                 #
# Switch          #
#                 #
###################

switch:
- platform: mqtt
  name: "Fireplace"
  state_topic: "esp8266/fireplace/switch1"
  command_topic: "esp8266/fireplace/switch1/set"
  qos: 0
  retain: false
  payload_on: "ON"
  payload_off: "OFF"
- platform: mqtt
  name: "Guest Bathroom Fan"
  state_topic: "smartthings/Guest Bathroom Fan/switch"
  command_topic: "smartthings/Guest Bathroom Fan/switch"
  qos: 0
  retain: true
  payload_on: "on"
  payload_off: "off"
  optimistic: false
- platform: mqtt
  name: "Master Bathroom Fan"
  state_topic: "smartthings/Master bathroom fan/switch"
  command_topic: "smartthings/Master bathroom fan/switch"
  qos: 0
  retain: true
  payload_on: "on"
  payload_off: "off"
  optimistic: false


###################
#                 #
# Input Boolean   #
#                 #
###################

input_boolean:
# Used for homekit integration
  set_mode_sleeping:
    name: set_mode_sleeping
    initial: off
  set_mode_home:
    name: set_mode_home
  set_mode_away:
    name: set_mode_away
# Automation Control switches
  lux_light_control:
    name: lux_light_control
    initial: on
# Fireplace Control switch
  fireplace_automation:
    name: fireplace_automation
    initial: off
# Homekit Presence
  presence_homekit:
    name: presence_homekit
    initial: on

###################
#                 #
# Input Select    #
#                 #
###################

input_select:
  automation_mode:
    name: 'Automation Mode'
    options:
     - Home
     - Away
     - Sleeping
     - No Automation
    initial: Home
    icon: mdi:panda
  # List must match harmony.config names for automation scripts
  living_room_remote:
    name: 'Living Room Remote'
    options:
     - 'Watch TV'
     - 'Apple TV'
     - 'Music - cable'
     - 'PowerOff'
     - 'Music - cable - deck'
     - 'Apple TV - Deck'
     - 'Watch Netflix'
     - 'Watch Blu-Ray'
     - 'Watch TV / No Stereo'
    initial: 'PowerOff'
    icon: mdi:monitor

      
###################
#                 #
# Input Number    #
#                 #
###################

input_number:
  denon_volume:
    name: Denon Volume
    initial: 30
    min: 0
    max: 50 
    step: .5
  denon_deck_volume:
    name: Denon Deck Volume
    initial: 40
    min: 0
    max: 70 
    step: .5
  lux_low_setpoint:
    name: lux low setpoint
    initial: 150
    min: 0
    max: 300
    step: 10
  lux_high_setpoint:
    name: lux high setpoint
    initial: 200
    min: 0
    max: 300
    step: 10
  cloud_cover_setpoint:
    name: cloud cover setpoint
    initial: 75
    min: 0
    max: 100
    step: 5
  fireplace_low_setpoint:
    name: fireplace low setpoint
    initial: 66
    min: 60
    max: 70
    step: 1
  fireplace_high_setpoint:
    name: fireplace high setpoint
    initial: 72
    min: 70
    max: 80
    step: 1
  internet_traffic_delta_in:
    name: "Traffic IN Delta"
    mode: box
    initial: 0
    min: 0
    max: 1000000000000
    unit_of_measurement: 'Mbps'
  internet_traffic_delta_out:
    name: "Traffic OUT Delta"
    mode: box
    initial: 0
    min: 0
    max: 1000000000000
    unit_of_measurement: 'Mbps'


###################
#                 #
# Timer           #
#                 #
###################

timer:
  guest_bathroom_fan_timer1:
    duration: '00:10:00'
  guest_bathroom_fan_timer2:
    duration: '00:30:00'
  master_bathroom_fan_timer1:
    duration: '00:10:00'
  master_bathroom_fan_timer2:
    duration: '00:45:00'

###################
#                 #
# History Graph   #
#                 #
###################

history_graph:
  lux1:
    name: Light Levels
    entities:
      - binary_sensor.low_lux
      - binary_sensor.high_lux
      - sensor.living_room_lux
      - sensor.dark_sky_cloud_coverage
    hours_to_show: 48
    refresh: 120
  temperatures:
    name: Temperatures
    entities:
       - sensor.basement_temperature
#      - sensor.basement_temperature_2
       - sensor.living_room_temperature
       - sensor.main_floor_temperature
    hours_to_show: 48
    refresh: 120
  presence:
    name: Presence
    entities:
      - input_boolean.presence_homekit
      - device_tracker.nikki
      - device_tracker.phil
 
group: !include groups.yaml

script: !include scripts.yaml

automation: !include automations.yaml

shell_command: !include shell_commands.yaml

